{
  "resourceType": "Library",
  "id": "OMTKLogicMK2020",
  "text": {
    "status": "generated",
    "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><table class=\"grid dict\"><tr><th scope=\"row\"><b>Id: </b></th><td style=\"padding-left: 25px; padding-right: 25px;\">library-OMTKLogicMK2020</td></tr><tr><th scope=\"row\"><b>Type: </b></th><td style=\"padding-right: 25px;\"> logic-library </td></tr><tr><th scope=\"row\"><b>Version: </b></th><td style=\"padding-left: 25px; padding-right: 25px;\">0.1.1</td></tr><tr><th scope=\"row\"><b>Status: </b></th><td style=\"padding-left: 25px; padding-right: 25px;\">active</td></tr><tr style=\"vertical-align: top;\"><th rowspan=\"1\" scope=\"row\"><b>Related: </b></th><td style=\"padding-left: 25px; padding-right: 25px;\"><p style=\"margin-bottom: 5px;\"><b>type: </b><span>depends-on</span></p><p style=\"margin-bottom: 5px;\"><b>Resource: </b><br/><span>http://fhir.org/guides/cdc/opioid-cds/Library/OMTKData2020</span></p></td></tr><tr style=\"vertical-align: top;\"><th scope=\"row\"><b>Content: </b></th><td style=\"padding-left: 25px; padding-right: 25px;\"><b>type: </b><span>text/cql</span></td></tr><tr><td colspan=\"2\" style=\"padding-left: 25px; padding-right: 25px;\"><pre><code class=\"language-cql\">library OMTKLogicMK2020 version '0.1.1'\n\n/*\nThis version of the OMTKLogic library uses the FHIR MedicationKnowledge Resource\nas the source for drug ingredient and strength information, rather than the\nOMTK data source.\n*/\n\nusing FHIR version '4.0.1'\n\ninclude OMTKData2020 version '0.1.1' called OMTKData\n\ncodesystem RxNorm: 'http://www.nlm.nih.gov/research/umls/rxnorm'\n\ncontext Patient\n\n/*\n  Normalizes the input units to UCUM units\n\n  Note guidance for UCUM presentation of medication units from SNOMED here:\n  https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0ahUKEwjU3vLpicPTAhWFMGMKHRpOBUAQFggiMAA&amp;url=https%3A%2F%2Fconfluence.ihtsdotools.org%2Fdownload%2Fattachments%2F17859188%2FExpressing%2520Units%2520of%2520Measure%2520for%2520Medicinal%2520Products.doc%3Fapi%3Dv2&amp;usg=AFQjCNE5sboicqvJDUyXJ2im8VzBpgHE8A\n\n  The values listed here are the only ones currently present in the OMTK data\n\n  Based on the HL7 UCUM subset here:\n  http://download.hl7.de/documents/ucum/ucumdata.html\n*/\ndefine function ToUCUM(unit System.String):\n  case unit\n    when 'MG' then 'mg'\n    when 'MG/ACTUAT' then 'mg/{actuat}'\n    when 'MG/HR' then 'mg/h'\n    when 'MG/ML' then 'mg/mL'\n    else 'Error: unknown{' + unit + '}'\n  end\n\n/*\n  Calculates daily frequency given frequency within a period\n*/\ndefine function ToDaily(frequency System.Integer, period System.Quantity):\n  case period.unit\n    when 'h' then frequency * (24.0 / period.value)\n    when 'min' then frequency * (24.0 / period.value) * 60\n    when 's' then frequency * (24.0 / period.value) * 60 * 60\n    when 'd' then frequency * (24.0 / period.value) / 24\n    when 'wk' then frequency * (24.0 / period.value) / (24 * 7)\n    when 'mo' then frequency * (24.0 / period.value) / (24 * 30) /* assuming 30 days in month */\n    when 'a' then frequency * (24.0 / period.value) / (24 * 365) /* assuming 365 days in year */\n    else null\n  end\n\n/*\n  Returns true if the given dose form is a patch (transdermal system)\n*/\ndefine function IsPatch(doseFormCode System.Code):\n  ToInteger(doseFormCode.code) = 316987\n\n/*\n  Returns the conversion factor for the given ingredient\n\nOpioid (strength in mg except where noted)\tMME Conversion Factor*\nBuprenorphine, transdermal patch (MCG/HR)\t12.6\nBuprenorphine, tablet or film\t30\nBuprenorphine, film (MCG)\t0.03\nButorphanol\t7\nCodeine\t0.15\nDihydrocodeine\t0.25\nFentanyl, buccal/SL tabet or lozenge/troche (MCG)\t0.13\nFentanyl, film or oral spray (MCG)\t0.18\nFentanyl, nasal spray (MCG)\t0.16\nFentanyl, transdermal patch (MCG/HR)\t2.4\nHydrocodone\t1\nHydromorphone\t4\nLevomethadyl acetate\t8\nLevorphanol tartrate\t11\nMeperidine \t0.1\nMethadone\t3\n  1-20 mg/d 4\n  21-40 mg/d 8\n  41-60 mg/d 10\n  61-80 mg/d 12\nMorphine\t1\nOpium\t1 // NOTE: Not present as an ingredient in the RxNorm data\nOxycodone\t1.5\nOxymorphone\t3\nPentazocine\t0.37\nTapentadol\t0.4\nTramadol\t0.1\n\n*/\ndefine function GetConversionFactor(ingredientCode System.Code, dailyDose System.Quantity, doseFormCode System.Code):\n  case ToInteger(ingredientCode.code)\n    when 161 then 0  /*\tAcetaminophen */\n    when 1191 then 0 /*\tAspirin */\n    when 1223 then 0 /*\tAtropine */\n    when 1767 then 0 /*\tBrompheniramine */\n    when 1819 then ( /*\tBuprenorphine */\n      case\n        when ToInteger(doseFormCode.code) = 316987 then 12.6 /* Transdermal system */\n        else 30 /* Tablet or Film (or Film in MCG) */\n      end\n    )\n    when 1841 then 7 /*\tButorphanol */\n    when 1886 then 0 /*\tCaffeine */\n    when 2101 then 0 /*\tCarisoprodol */\n    when 2354 then 0 /*\tchlorcyclizine */\n    when 2400 then 0 /*\tChlorpheniramine */\n    when 2670 then 0.15 /*\tCodeine */\n    when 3423 then 4 /*\tHydromorphone */\n    when 3498 then 0 /*\tDiphenhydramine */\n    when 4337 then ( /*\tFentanyl */\n      case\n        when ToInteger(doseFormCode.code) in { 970789, 317007, 316992 } then 0.13 /* Buccal Tablet, Sublingual Tablet, Oral Lozenge */\n        when ToInteger(doseFormCode.code) = 858080 then 0.18 /* Buccal Film */\n        when ToInteger(doseFormCode.code) in { 126542, 346163 } then 0.16 /* Nasal Spray, Mucosal Spray */\n        when IsPatch(doseFormCode) then 2.4 /* Transdermal system */\n        else 1000 /* Really ought to be an error because it represents a previously unencountered dose form.... */\n      end\n    )\n    when 5032 then 0 /*\tGuaifenesin */\n    when 5489 then 1 /*\tHydrocodone */\n    when 5640 then 0 /*\tIbuprofen */\n    when 6102 then 0 /*\tKaolin */\n    when 6378 then 11 /*\tLevorphanol (NOTE: Given as Levorphanol tartrate in the CDC conversion table) */\n    when 6754 then 0.1 /*\tMeperidine */\n    when 6813 then ( /*\tMethadone */\n      case\n        when dailyDose.value between 1 and 20 then 4\n        when dailyDose.value between 21 and 40 then 8\n        when dailyDose.value between 41 and 60 then 10\n        when dailyDose.value &gt;= 61 then 12\n        else 1000 /* Really ought to be an error because it represents an unexpected dose range... */\n      end\n    )\n    when 7052 then 1 /*\tMorphine */\n    when 7242 then 0 /*\tNaloxone */\n    when 7243 then 0 /*\tNaltrexone */\n    when 7804 then 1.5 /*\tOxycodone */\n    when 7814 then 3 /*\tOxymorphone */\n    when 8001 then 0.37 /*\tPentazocine */\n    when 8163 then 0 /*\tPhenylephrine */\n    when 8175 then 0 /*\tPhenylpropanolamine */\n    when 8745 then 0 /*\tPromethazine */\n    when 8896 then 0 /*\tPseudoephedrine */\n    when 9009 then 0 /*\tPyrilamine */\n    when 10689 then 0.1 /*\tTramadol */\n    when 10849 then 0 /*\tTriprolidine */\n    when 19759 then 0 /*\tbromodiphenhydramine */\n    when 19860 then 0 /*\tbutalbital */\n    when 22696 then 0 /*\tdexbrompheniramine */\n    when 22697 then 0 /*\tdexchlorpheniramine */\n    when 23088 then 0.25 /*\tdihydrocodeine */\n    when 27084 then 0 /*\thomatropine */\n    when 35780 then 0 /*\tropivacaine */\n    when 237005 then 8 /*\tLevomethadyl (NOTE: given as Levomethadyl acetate in the CDC conversion table) */\n    when 636827 then 0 /*\tguaiacolsulfonate */\n    when 787390 then 0.4 /*\ttapentadol */\n    else 0\n  end\n\ndefine function EnsureMicrogramQuantity(strength System.Quantity):\n  if strength.value &lt; 0.1 and (PositionOf('mg', strength.unit) = 0) then\n    System.Quantity {\n      value: strength.value * 1000,\n      unit: 'mcg' + Substring(strength.unit, 2)\n    }\n  else\n    strength\n\n/*\n  Returns the non-surgical opioid ingredients and their strengths that\n  make up the drug identified by the given rxNormCode as a list of tuples:\n\n  List&lt;Tuple {\n    rxNormCode Code,\n    doseFormCode Code,\n    doseFormName String,\n    ingredientCode Code,\n    ingredientName String,\n    strength Quantity\n  }&gt;\n*/\n\n/*\nDrugIngredients:\n  List&lt;{\n    drugCode Integer,\n    drugName String,\n    doseFormCode Integer,\n    doseFormName String,\n    ingredientCode Integer,\n    ingredientName String,\n    strength String,\n    strengthValue Decimal,\n    strengthUnit String\n  }&gt;\n*/\ndefine function GetIngredients(rxNormCode System.Code):\n  OMTKData.DrugIngredients DI\n    where DI.drugCode = ToInteger(rxNormCode.code)\n    return {\n      rxNormCode: System.Code { code: ToString(DI.drugCode), system: 'http://www.nlm.nih.gov/research/umls/rxnorm', display: DI.drugName },\n      doseFormCode: System.Code { code: ToString(DI.doseFormCode), system: 'http://www.nlm.nih.gov/research/umls/rxnorm', display: DI.doseFormName },\n      doseFormName: DI.doseFormName,\n      ingredientCode: System.Code { code: ToString(DI.ingredientCode), system: 'http://www.nlm.nih.gov/research/umls/rxnorm', display: DI.ingredientName },\n      ingredientName: DI.ingredientName,\n      strength: EnsureMicrogramQuantity(\n          System.Quantity {\n            value: DI.strengthValue,\n            unit: ToUCUM(DI.strengthUnit)\n          }\n        )\n    }\n\n/* define function GetIngredients(rxNormCode Code):\n  flatten (\n    [MedicationKnowledge: rxNormCode] M\n      return\n        M.ingredient I\n          where I.code in &quot;Opioid Ingredients&quot; // TODO: Need a value set of opioid ingredients\n          return {\n            rxNormCode: M.code,\n            doseFormCode: M.doseForm, // TODO: MedicationKnowledge specifies SNOMED-CT dose forms here, would need to profile to RXNorm\n            doseFormName: M.doseForm.text,\n            ingredientCode: I.item as CodeableConcept, // TODO: Profile to code only\n            ingredientName: (I.item as CodeableConcept).text,\n            strength: EnsureMicrogramQuantity(I.strength.denominator) // TODO: Is this correct?\n          }\n  ) */\n\n/*\n  Calculates daily dose for a specific ingredient based on the ingredient strength, dose form, dose quantity, and daily frequency\n*/\ndefine function GetDailyDose(ingredientCode System.Code, strength System.Quantity, doseFormCode System.Code, doseQuantity System.Quantity, dosesPerDay System.Decimal):\n  case\n\t  /* if patch --&gt; daily dose = dose value (e.g, number patches with doseQuantity unit = &quot;patch&quot;) * per-hour strength */\n    when IsPatch(doseFormCode) then\n      /* buprenorphine or fentanyl patch */\n      if ToInteger(ingredientCode.code) in { 1819, 4337 } then\n        System.Quantity {\n          value: dosesPerDay * doseQuantity.value * strength.value,\n          unit: strength.unit\n        }\n      else\n        null\n\n    /* if dose unit in actual mass units (mg or mcg -- when it's a single med) --&gt; daily dose = numTimesPerDay * dose */\n    when doseQuantity.unit in { 'mg', 'mcg' } then\n      System.Quantity {\n        value: dosesPerDay * doseQuantity.value,\n        unit: doseQuantity.unit\n      }\n\n    /* if doseQuantity is in actual volume units (mL) --&gt; daily dose = numTimesPerDay * dose * strength */\n    when doseQuantity.unit = 'mL' and (PositionOf('/mL', strength.unit) = Length(strength.unit) - 3) then\n      System.Quantity {\n        value: dosesPerDay * doseQuantity.value * strength.value,\n        unit: Substring(strength.unit, 0, PositionOf('/', strength.unit))\n      }\n\n\t\t/* if doseQuantity is not in actual units (e.g., 1 tab, 1 spray -- when it's a combo med with a unit of tablet, or it's mg/actuat) --&gt;  daily dose = numTimesPerDay * dose value * strength value */\n    else\n      System.Quantity {\n        value: dosesPerDay * doseQuantity.value * strength.value,\n        unit: Substring(strength.unit, 0, PositionOf('/', strength.unit))\n      }\n  end\n\ndefine function GetMedicationName(rxNormCode System.Code):\n  if rxNormCode.display is null then\n    SingletonFrom(\n      OMTKData.DrugIngredients DI\n        where DI.drugCode = ToInteger(rxNormCode.code)\n        return DI.drugName\n    )\n    else rxNormCode.display\n\n/*\n  Builds a description for the daily dose for an ingredient\n*/\ndefine function GetDailyDoseDescription(ingredientCode System.Code, ingredientName System.String, strength System.Quantity, doseFormCode System.Code, doseFormName System.String, doseQuantity System.Quantity, dosesPerDay System.Decimal, dailyDose System.Quantity):\n  case\n    /* if patch */\n    when IsPatch(doseFormCode) then\n      /* buprenorphine or fentanyl patch */\n      if ToInteger(ingredientCode.code) in { 1819, 4337 } then\n        ingredientName + ' patch: ' + ToString(doseQuantity.value) + ' * ' + ToString(strength.value) + ' = ' + ToString(dailyDose.value)\n      else\n        null\n\n    /* if dose unit in actual mass units (mg or mcg -- when it's a single med) */\n    when doseQuantity.unit in { 'mg', 'mcg' } then\n      ingredientName + ' ' + doseFormName + ': ' + ToString(dosesPerDay) + '/d * ' + ToString(doseQuantity.value) + ' = ' + ToString(dailyDose.value)\n\n    /* if doseQuantity in actual volume units (mL) or not in actual units (e.g. 1 tab, 1 spray) */\n    else\n      ingredientName + ' ' + doseFormName + ': ' + ToString(dosesPerDay) + '/d * ' + ToString(doseQuantity.value) + ' * ' + ToString(strength.value) + ' = ' + ToString(dailyDose.value)\n  end\n\n/*\n  Calculates MMEs for the given input prescription information and returns it\n  as a list of tuples:\n\n  List&lt;Tuple {\n    rxNormCode Code,\n    doseFormCode Code,\n    doseQuantity Quantity,\n    dosesPerDay Decimal,\n    ingredientCode Code,\n    ingredientName String,\n    strength Quantity,\n    dailyDose Quantity,\n    dailyDoseDescription String,\n    conversionFactor Decimal,\n    mme Quantity\n  }&gt;\n*/\ndefine function CalculateMMEs(medications List&lt;Tuple { rxNormCode System.Code, doseQuantity System.Quantity, dosesPerDay System.Decimal }&gt;):\n  Flatten(\n    medications M\n      let Ingredients: GetIngredients(M.rxNormCode)\n      return\n        Ingredients I\n          let\n            adjustedDoseQuantity: EnsureMicrogramQuantity(M.doseQuantity),\n            dailyDose: GetDailyDose(I.ingredientCode, I.strength, I.doseFormCode, adjustedDoseQuantity, M.dosesPerDay),\n            factor: GetConversionFactor(I.ingredientCode, dailyDose, I.doseFormCode)\n          return {\n            rxNormCode: M.rxNormCode,\n            doseFormCode: I.doseFormCode,\n            doseQuantity: adjustedDoseQuantity,\n            dosesPerDay: M.dosesPerDay,\n            ingredientCode: I.ingredientCode,\n            ingredientName: I.ingredientName,\n            strength: I.strength,\n            dailyDose: dailyDose,\n            dailyDoseDescription: GetDailyDoseDescription(I.ingredientCode, I.ingredientName, I.strength, I.doseFormCode, I.doseFormName, adjustedDoseQuantity, M.dosesPerDay, dailyDose),\n            conversionFactor: factor,\n            mme: System.Quantity {\n              value: dailyDose.value * factor,\n              unit: dailyDose.unit + '/d'\n            }\n          }\n  )\n\n/* define TestCalculateMMEs:\n  CalculateMMEs({ { rxNormCode: Code '388508' from RxNorm, doseQuantity: Quantity { value: 1, unit: 'patch' }, dosesPerDay: 0.33 } }) */\n</code></pre>\n                    \n                    \n                </td>\n            </tr>\n        \n    </table>\n</div>"
  },
  "extension": [ {
    "url": "http://hl7.org/fhir/us/cqfmeasures/StructureDefinition/cqfm-softwaresystem",
    "valueReference": {
      "reference": "Device/cqf-tooling"
    }
  }, {
    "url": "http://hl7.org/fhir/us/cqfmeasures/StructureDefinition/cqfm-softwaresystem",
    "valueReference": {
      "reference": "Device/cqf-tooling"
    }
  } ],
  "url": "http://fhir.org/guides/cdc/opioid-cds/Library/OMTKLogicMK2020",
  "version": "0.1.1",
  "name": "OMTKLogicMK2020",
  "title": "Library - OMTK Data (2020)",
  "status": "active",
  "experimental": true,
  "type": {
    "coding": [ {
      "system": "http://terminology.hl7.org/CodeSystem/library-type",
      "code": "logic-library"
    } ]
  },
  "relatedArtifact": [ {
    "type": "depends-on",
    "display": "FHIR model information",
    "resource": "http://fhir.org/guides/cqf/common/Library/FHIR-ModelInfo|4.0.1"
  }, {
    "type": "depends-on",
    "display": "Library OMTKData",
    "resource": "http://fhir.org/guides/cdc/opioid-cds/Library/OMTKData2020|0.1.1"
  }, {
    "type": "depends-on",
    "display": "Code system RxNorm",
    "resource": "http://www.nlm.nih.gov/research/umls/rxnorm"
  } ],
  "parameter": [ {
    "name": "Patient",
    "use": "out",
    "min": 0,
    "max": "1",
    "type": "Patient"
  } ],
  "dataRequirement": [ {
    "type": "Patient",
    "profile": [ "http://hl7.org/fhir/StructureDefinition/Patient" ]
  } ],
  "content": [ {
    "contentType": "text/cql",
    "data": "bGlicmFyeSBPTVRLTG9naWNNSzIwMjAgdmVyc2lvbiAnMC4xLjEnCgovKgpUaGlzIHZlcnNpb24gb2YgdGhlIE9NVEtMb2dpYyBsaWJyYXJ5IHVzZXMgdGhlIEZISVIgTWVkaWNhdGlvbktub3dsZWRnZSBSZXNvdXJjZQphcyB0aGUgc291cmNlIGZvciBkcnVnIGluZ3JlZGllbnQgYW5kIHN0cmVuZ3RoIGluZm9ybWF0aW9uLCByYXRoZXIgdGhhbiB0aGUKT01USyBkYXRhIHNvdXJjZS4KKi8KCnVzaW5nIEZISVIgdmVyc2lvbiAnNC4wLjEnCgppbmNsdWRlIE9NVEtEYXRhMjAyMCB2ZXJzaW9uICcwLjEuMScgY2FsbGVkIE9NVEtEYXRhCgpjb2Rlc3lzdGVtIFJ4Tm9ybTogJ2h0dHA6Ly93d3cubmxtLm5paC5nb3YvcmVzZWFyY2gvdW1scy9yeG5vcm0nCgpjb250ZXh0IFBhdGllbnQKCi8qCiAgTm9ybWFsaXplcyB0aGUgaW5wdXQgdW5pdHMgdG8gVUNVTSB1bml0cwoKICBOb3RlIGd1aWRhbmNlIGZvciBVQ1VNIHByZXNlbnRhdGlvbiBvZiBtZWRpY2F0aW9uIHVuaXRzIGZyb20gU05PTUVEIGhlcmU6CiAgaHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS91cmw/c2E9dCZyY3Q9aiZxPSZlc3JjPXMmc291cmNlPXdlYiZjZD0xJmNhZD1yamEmdWFjdD04JnZlZD0wYWhVS0V3alUzdkxwaWNQVEFoV0ZNR01LSFJwT0JVQVFGZ2dpTUFBJnVybD1odHRwcyUzQSUyRiUyRmNvbmZsdWVuY2UuaWh0c2RvdG9vbHMub3JnJTJGZG93bmxvYWQlMkZhdHRhY2htZW50cyUyRjE3ODU5MTg4JTJGRXhwcmVzc2luZyUyNTIwVW5pdHMlMjUyMG9mJTI1MjBNZWFzdXJlJTI1MjBmb3IlMjUyME1lZGljaW5hbCUyNTIwUHJvZHVjdHMuZG9jJTNGYXBpJTNEdjImdXNnPUFGUWpDTkU1c2JvaWNxdkpEVXlYSjJpbThWekJwZ0hFOEEKCiAgVGhlIHZhbHVlcyBsaXN0ZWQgaGVyZSBhcmUgdGhlIG9ubHkgb25lcyBjdXJyZW50bHkgcHJlc2VudCBpbiB0aGUgT01USyBkYXRhCgogIEJhc2VkIG9uIHRoZSBITDcgVUNVTSBzdWJzZXQgaGVyZToKICBodHRwOi8vZG93bmxvYWQuaGw3LmRlL2RvY3VtZW50cy91Y3VtL3VjdW1kYXRhLmh0bWwKKi8KZGVmaW5lIGZ1bmN0aW9uIFRvVUNVTSh1bml0IFN5c3RlbS5TdHJpbmcpOgogIGNhc2UgdW5pdAogICAgd2hlbiAnTUcnIHRoZW4gJ21nJwogICAgd2hlbiAnTUcvQUNUVUFUJyB0aGVuICdtZy97YWN0dWF0fScKICAgIHdoZW4gJ01HL0hSJyB0aGVuICdtZy9oJwogICAgd2hlbiAnTUcvTUwnIHRoZW4gJ21nL21MJwogICAgZWxzZSAnRXJyb3I6IHVua25vd257JyArIHVuaXQgKyAnfScKICBlbmQKCi8qCiAgQ2FsY3VsYXRlcyBkYWlseSBmcmVxdWVuY3kgZ2l2ZW4gZnJlcXVlbmN5IHdpdGhpbiBhIHBlcmlvZAoqLwpkZWZpbmUgZnVuY3Rpb24gVG9EYWlseShmcmVxdWVuY3kgU3lzdGVtLkludGVnZXIsIHBlcmlvZCBTeXN0ZW0uUXVhbnRpdHkpOgogIGNhc2UgcGVyaW9kLnVuaXQKICAgIHdoZW4gJ2gnIHRoZW4gZnJlcXVlbmN5ICogKDI0LjAgLyBwZXJpb2QudmFsdWUpCiAgICB3aGVuICdtaW4nIHRoZW4gZnJlcXVlbmN5ICogKDI0LjAgLyBwZXJpb2QudmFsdWUpICogNjAKICAgIHdoZW4gJ3MnIHRoZW4gZnJlcXVlbmN5ICogKDI0LjAgLyBwZXJpb2QudmFsdWUpICogNjAgKiA2MAogICAgd2hlbiAnZCcgdGhlbiBmcmVxdWVuY3kgKiAoMjQuMCAvIHBlcmlvZC52YWx1ZSkgLyAyNAogICAgd2hlbiAnd2snIHRoZW4gZnJlcXVlbmN5ICogKDI0LjAgLyBwZXJpb2QudmFsdWUpIC8gKDI0ICogNykKICAgIHdoZW4gJ21vJyB0aGVuIGZyZXF1ZW5jeSAqICgyNC4wIC8gcGVyaW9kLnZhbHVlKSAvICgyNCAqIDMwKSAvKiBhc3N1bWluZyAzMCBkYXlzIGluIG1vbnRoICovCiAgICB3aGVuICdhJyB0aGVuIGZyZXF1ZW5jeSAqICgyNC4wIC8gcGVyaW9kLnZhbHVlKSAvICgyNCAqIDM2NSkgLyogYXNzdW1pbmcgMzY1IGRheXMgaW4geWVhciAqLwogICAgZWxzZSBudWxsCiAgZW5kCgovKgogIFJldHVybnMgdHJ1ZSBpZiB0aGUgZ2l2ZW4gZG9zZSBmb3JtIGlzIGEgcGF0Y2ggKHRyYW5zZGVybWFsIHN5c3RlbSkKKi8KZGVmaW5lIGZ1bmN0aW9uIElzUGF0Y2goZG9zZUZvcm1Db2RlIFN5c3RlbS5Db2RlKToKICBUb0ludGVnZXIoZG9zZUZvcm1Db2RlLmNvZGUpID0gMzE2OTg3CgovKgogIFJldHVybnMgdGhlIGNvbnZlcnNpb24gZmFjdG9yIGZvciB0aGUgZ2l2ZW4gaW5ncmVkaWVudAoKT3Bpb2lkIChzdHJlbmd0aCBpbiBtZyBleGNlcHQgd2hlcmUgbm90ZWQpCU1NRSBDb252ZXJzaW9uIEZhY3RvcioKQnVwcmVub3JwaGluZSwgdHJhbnNkZXJtYWwgcGF0Y2ggKE1DRy9IUikJMTIuNgpCdXByZW5vcnBoaW5lLCB0YWJsZXQgb3IgZmlsbQkzMApCdXByZW5vcnBoaW5lLCBmaWxtIChNQ0cpCTAuMDMKQnV0b3JwaGFub2wJNwpDb2RlaW5lCTAuMTUKRGloeWRyb2NvZGVpbmUJMC4yNQpGZW50YW55bCwgYnVjY2FsL1NMIHRhYmV0IG9yIGxvemVuZ2UvdHJvY2hlIChNQ0cpCTAuMTMKRmVudGFueWwsIGZpbG0gb3Igb3JhbCBzcHJheSAoTUNHKQkwLjE4CkZlbnRhbnlsLCBuYXNhbCBzcHJheSAoTUNHKQkwLjE2CkZlbnRhbnlsLCB0cmFuc2Rlcm1hbCBwYXRjaCAoTUNHL0hSKQkyLjQKSHlkcm9jb2RvbmUJMQpIeWRyb21vcnBob25lCTQKTGV2b21ldGhhZHlsIGFjZXRhdGUJOApMZXZvcnBoYW5vbCB0YXJ0cmF0ZQkxMQpNZXBlcmlkaW5lIAkwLjEKTWV0aGFkb25lCTMKICAxLTIwIG1nL2QgNAogIDIxLTQwIG1nL2QgOAogIDQxLTYwIG1nL2QgMTAKICA2MS04MCBtZy9kIDEyCk1vcnBoaW5lCTEKT3BpdW0JMSAvLyBOT1RFOiBOb3QgcHJlc2VudCBhcyBhbiBpbmdyZWRpZW50IGluIHRoZSBSeE5vcm0gZGF0YQpPeHljb2RvbmUJMS41Ck94eW1vcnBob25lCTMKUGVudGF6b2NpbmUJMC4zNwpUYXBlbnRhZG9sCTAuNApUcmFtYWRvbAkwLjEKCiovCmRlZmluZSBmdW5jdGlvbiBHZXRDb252ZXJzaW9uRmFjdG9yKGluZ3JlZGllbnRDb2RlIFN5c3RlbS5Db2RlLCBkYWlseURvc2UgU3lzdGVtLlF1YW50aXR5LCBkb3NlRm9ybUNvZGUgU3lzdGVtLkNvZGUpOgogIGNhc2UgVG9JbnRlZ2VyKGluZ3JlZGllbnRDb2RlLmNvZGUpCiAgICB3aGVuIDE2MSB0aGVuIDAgIC8qCUFjZXRhbWlub3BoZW4gKi8KICAgIHdoZW4gMTE5MSB0aGVuIDAgLyoJQXNwaXJpbiAqLwogICAgd2hlbiAxMjIzIHRoZW4gMCAvKglBdHJvcGluZSAqLwogICAgd2hlbiAxNzY3IHRoZW4gMCAvKglCcm9tcGhlbmlyYW1pbmUgKi8KICAgIHdoZW4gMTgxOSB0aGVuICggLyoJQnVwcmVub3JwaGluZSAqLwogICAgICBjYXNlCiAgICAgICAgd2hlbiBUb0ludGVnZXIoZG9zZUZvcm1Db2RlLmNvZGUpID0gMzE2OTg3IHRoZW4gMTIuNiAvKiBUcmFuc2Rlcm1hbCBzeXN0ZW0gKi8KICAgICAgICBlbHNlIDMwIC8qIFRhYmxldCBvciBGaWxtIChvciBGaWxtIGluIE1DRykgKi8KICAgICAgZW5kCiAgICApCiAgICB3aGVuIDE4NDEgdGhlbiA3IC8qCUJ1dG9ycGhhbm9sICovCiAgICB3aGVuIDE4ODYgdGhlbiAwIC8qCUNhZmZlaW5lICovCiAgICB3aGVuIDIxMDEgdGhlbiAwIC8qCUNhcmlzb3Byb2RvbCAqLwogICAgd2hlbiAyMzU0IHRoZW4gMCAvKgljaGxvcmN5Y2xpemluZSAqLwogICAgd2hlbiAyNDAwIHRoZW4gMCAvKglDaGxvcnBoZW5pcmFtaW5lICovCiAgICB3aGVuIDI2NzAgdGhlbiAwLjE1IC8qCUNvZGVpbmUgKi8KICAgIHdoZW4gMzQyMyB0aGVuIDQgLyoJSHlkcm9tb3JwaG9uZSAqLwogICAgd2hlbiAzNDk4IHRoZW4gMCAvKglEaXBoZW5oeWRyYW1pbmUgKi8KICAgIHdoZW4gNDMzNyB0aGVuICggLyoJRmVudGFueWwgKi8KICAgICAgY2FzZQogICAgICAgIHdoZW4gVG9JbnRlZ2VyKGRvc2VGb3JtQ29kZS5jb2RlKSBpbiB7IDk3MDc4OSwgMzE3MDA3LCAzMTY5OTIgfSB0aGVuIDAuMTMgLyogQnVjY2FsIFRhYmxldCwgU3VibGluZ3VhbCBUYWJsZXQsIE9yYWwgTG96ZW5nZSAqLwogICAgICAgIHdoZW4gVG9JbnRlZ2VyKGRvc2VGb3JtQ29kZS5jb2RlKSA9IDg1ODA4MCB0aGVuIDAuMTggLyogQnVjY2FsIEZpbG0gKi8KICAgICAgICB3aGVuIFRvSW50ZWdlcihkb3NlRm9ybUNvZGUuY29kZSkgaW4geyAxMjY1NDIsIDM0NjE2MyB9IHRoZW4gMC4xNiAvKiBOYXNhbCBTcHJheSwgTXVjb3NhbCBTcHJheSAqLwogICAgICAgIHdoZW4gSXNQYXRjaChkb3NlRm9ybUNvZGUpIHRoZW4gMi40IC8qIFRyYW5zZGVybWFsIHN5c3RlbSAqLwogICAgICAgIGVsc2UgMTAwMCAvKiBSZWFsbHkgb3VnaHQgdG8gYmUgYW4gZXJyb3IgYmVjYXVzZSBpdCByZXByZXNlbnRzIGEgcHJldmlvdXNseSB1bmVuY291bnRlcmVkIGRvc2UgZm9ybS4uLi4gKi8KICAgICAgZW5kCiAgICApCiAgICB3aGVuIDUwMzIgdGhlbiAwIC8qCUd1YWlmZW5lc2luICovCiAgICB3aGVuIDU0ODkgdGhlbiAxIC8qCUh5ZHJvY29kb25lICovCiAgICB3aGVuIDU2NDAgdGhlbiAwIC8qCUlidXByb2ZlbiAqLwogICAgd2hlbiA2MTAyIHRoZW4gMCAvKglLYW9saW4gKi8KICAgIHdoZW4gNjM3OCB0aGVuIDExIC8qCUxldm9ycGhhbm9sIChOT1RFOiBHaXZlbiBhcyBMZXZvcnBoYW5vbCB0YXJ0cmF0ZSBpbiB0aGUgQ0RDIGNvbnZlcnNpb24gdGFibGUpICovCiAgICB3aGVuIDY3NTQgdGhlbiAwLjEgLyoJTWVwZXJpZGluZSAqLwogICAgd2hlbiA2ODEzIHRoZW4gKCAvKglNZXRoYWRvbmUgKi8KICAgICAgY2FzZQogICAgICAgIHdoZW4gZGFpbHlEb3NlLnZhbHVlIGJldHdlZW4gMSBhbmQgMjAgdGhlbiA0CiAgICAgICAgd2hlbiBkYWlseURvc2UudmFsdWUgYmV0d2VlbiAyMSBhbmQgNDAgdGhlbiA4CiAgICAgICAgd2hlbiBkYWlseURvc2UudmFsdWUgYmV0d2VlbiA0MSBhbmQgNjAgdGhlbiAxMAogICAgICAgIHdoZW4gZGFpbHlEb3NlLnZhbHVlID49IDYxIHRoZW4gMTIKICAgICAgICBlbHNlIDEwMDAgLyogUmVhbGx5IG91Z2h0IHRvIGJlIGFuIGVycm9yIGJlY2F1c2UgaXQgcmVwcmVzZW50cyBhbiB1bmV4cGVjdGVkIGRvc2UgcmFuZ2UuLi4gKi8KICAgICAgZW5kCiAgICApCiAgICB3aGVuIDcwNTIgdGhlbiAxIC8qCU1vcnBoaW5lICovCiAgICB3aGVuIDcyNDIgdGhlbiAwIC8qCU5hbG94b25lICovCiAgICB3aGVuIDcyNDMgdGhlbiAwIC8qCU5hbHRyZXhvbmUgKi8KICAgIHdoZW4gNzgwNCB0aGVuIDEuNSAvKglPeHljb2RvbmUgKi8KICAgIHdoZW4gNzgxNCB0aGVuIDMgLyoJT3h5bW9ycGhvbmUgKi8KICAgIHdoZW4gODAwMSB0aGVuIDAuMzcgLyoJUGVudGF6b2NpbmUgKi8KICAgIHdoZW4gODE2MyB0aGVuIDAgLyoJUGhlbnlsZXBocmluZSAqLwogICAgd2hlbiA4MTc1IHRoZW4gMCAvKglQaGVueWxwcm9wYW5vbGFtaW5lICovCiAgICB3aGVuIDg3NDUgdGhlbiAwIC8qCVByb21ldGhhemluZSAqLwogICAgd2hlbiA4ODk2IHRoZW4gMCAvKglQc2V1ZG9lcGhlZHJpbmUgKi8KICAgIHdoZW4gOTAwOSB0aGVuIDAgLyoJUHlyaWxhbWluZSAqLwogICAgd2hlbiAxMDY4OSB0aGVuIDAuMSAvKglUcmFtYWRvbCAqLwogICAgd2hlbiAxMDg0OSB0aGVuIDAgLyoJVHJpcHJvbGlkaW5lICovCiAgICB3aGVuIDE5NzU5IHRoZW4gMCAvKglicm9tb2RpcGhlbmh5ZHJhbWluZSAqLwogICAgd2hlbiAxOTg2MCB0aGVuIDAgLyoJYnV0YWxiaXRhbCAqLwogICAgd2hlbiAyMjY5NiB0aGVuIDAgLyoJZGV4YnJvbXBoZW5pcmFtaW5lICovCiAgICB3aGVuIDIyNjk3IHRoZW4gMCAvKglkZXhjaGxvcnBoZW5pcmFtaW5lICovCiAgICB3aGVuIDIzMDg4IHRoZW4gMC4yNSAvKglkaWh5ZHJvY29kZWluZSAqLwogICAgd2hlbiAyNzA4NCB0aGVuIDAgLyoJaG9tYXRyb3BpbmUgKi8KICAgIHdoZW4gMzU3ODAgdGhlbiAwIC8qCXJvcGl2YWNhaW5lICovCiAgICB3aGVuIDIzNzAwNSB0aGVuIDggLyoJTGV2b21ldGhhZHlsIChOT1RFOiBnaXZlbiBhcyBMZXZvbWV0aGFkeWwgYWNldGF0ZSBpbiB0aGUgQ0RDIGNvbnZlcnNpb24gdGFibGUpICovCiAgICB3aGVuIDYzNjgyNyB0aGVuIDAgLyoJZ3VhaWFjb2xzdWxmb25hdGUgKi8KICAgIHdoZW4gNzg3MzkwIHRoZW4gMC40IC8qCXRhcGVudGFkb2wgKi8KICAgIGVsc2UgMAogIGVuZAoKZGVmaW5lIGZ1bmN0aW9uIEVuc3VyZU1pY3JvZ3JhbVF1YW50aXR5KHN0cmVuZ3RoIFN5c3RlbS5RdWFudGl0eSk6CiAgaWYgc3RyZW5ndGgudmFsdWUgPCAwLjEgYW5kIChQb3NpdGlvbk9mKCdtZycsIHN0cmVuZ3RoLnVuaXQpID0gMCkgdGhlbgogICAgU3lzdGVtLlF1YW50aXR5IHsKICAgICAgdmFsdWU6IHN0cmVuZ3RoLnZhbHVlICogMTAwMCwKICAgICAgdW5pdDogJ21jZycgKyBTdWJzdHJpbmcoc3RyZW5ndGgudW5pdCwgMikKICAgIH0KICBlbHNlCiAgICBzdHJlbmd0aAoKLyoKICBSZXR1cm5zIHRoZSBub24tc3VyZ2ljYWwgb3Bpb2lkIGluZ3JlZGllbnRzIGFuZCB0aGVpciBzdHJlbmd0aHMgdGhhdAogIG1ha2UgdXAgdGhlIGRydWcgaWRlbnRpZmllZCBieSB0aGUgZ2l2ZW4gcnhOb3JtQ29kZSBhcyBhIGxpc3Qgb2YgdHVwbGVzOgoKICBMaXN0PFR1cGxlIHsKICAgIHJ4Tm9ybUNvZGUgQ29kZSwKICAgIGRvc2VGb3JtQ29kZSBDb2RlLAogICAgZG9zZUZvcm1OYW1lIFN0cmluZywKICAgIGluZ3JlZGllbnRDb2RlIENvZGUsCiAgICBpbmdyZWRpZW50TmFtZSBTdHJpbmcsCiAgICBzdHJlbmd0aCBRdWFudGl0eQogIH0+CiovCgovKgpEcnVnSW5ncmVkaWVudHM6CiAgTGlzdDx7CiAgICBkcnVnQ29kZSBJbnRlZ2VyLAogICAgZHJ1Z05hbWUgU3RyaW5nLAogICAgZG9zZUZvcm1Db2RlIEludGVnZXIsCiAgICBkb3NlRm9ybU5hbWUgU3RyaW5nLAogICAgaW5ncmVkaWVudENvZGUgSW50ZWdlciwKICAgIGluZ3JlZGllbnROYW1lIFN0cmluZywKICAgIHN0cmVuZ3RoIFN0cmluZywKICAgIHN0cmVuZ3RoVmFsdWUgRGVjaW1hbCwKICAgIHN0cmVuZ3RoVW5pdCBTdHJpbmcKICB9PgoqLwpkZWZpbmUgZnVuY3Rpb24gR2V0SW5ncmVkaWVudHMocnhOb3JtQ29kZSBTeXN0ZW0uQ29kZSk6CiAgT01US0RhdGEuRHJ1Z0luZ3JlZGllbnRzIERJCiAgICB3aGVyZSBESS5kcnVnQ29kZSA9IFRvSW50ZWdlcihyeE5vcm1Db2RlLmNvZGUpCiAgICByZXR1cm4gewogICAgICByeE5vcm1Db2RlOiBTeXN0ZW0uQ29kZSB7IGNvZGU6IFRvU3RyaW5nKERJLmRydWdDb2RlKSwgc3lzdGVtOiAnaHR0cDovL3d3dy5ubG0ubmloLmdvdi9yZXNlYXJjaC91bWxzL3J4bm9ybScsIGRpc3BsYXk6IERJLmRydWdOYW1lIH0sCiAgICAgIGRvc2VGb3JtQ29kZTogU3lzdGVtLkNvZGUgeyBjb2RlOiBUb1N0cmluZyhESS5kb3NlRm9ybUNvZGUpLCBzeXN0ZW06ICdodHRwOi8vd3d3Lm5sbS5uaWguZ292L3Jlc2VhcmNoL3VtbHMvcnhub3JtJywgZGlzcGxheTogREkuZG9zZUZvcm1OYW1lIH0sCiAgICAgIGRvc2VGb3JtTmFtZTogREkuZG9zZUZvcm1OYW1lLAogICAgICBpbmdyZWRpZW50Q29kZTogU3lzdGVtLkNvZGUgeyBjb2RlOiBUb1N0cmluZyhESS5pbmdyZWRpZW50Q29kZSksIHN5c3RlbTogJ2h0dHA6Ly93d3cubmxtLm5paC5nb3YvcmVzZWFyY2gvdW1scy9yeG5vcm0nLCBkaXNwbGF5OiBESS5pbmdyZWRpZW50TmFtZSB9LAogICAgICBpbmdyZWRpZW50TmFtZTogREkuaW5ncmVkaWVudE5hbWUsCiAgICAgIHN0cmVuZ3RoOiBFbnN1cmVNaWNyb2dyYW1RdWFudGl0eSgKICAgICAgICAgIFN5c3RlbS5RdWFudGl0eSB7CiAgICAgICAgICAgIHZhbHVlOiBESS5zdHJlbmd0aFZhbHVlLAogICAgICAgICAgICB1bml0OiBUb1VDVU0oREkuc3RyZW5ndGhVbml0KQogICAgICAgICAgfQogICAgICAgICkKICAgIH0KCi8qIGRlZmluZSBmdW5jdGlvbiBHZXRJbmdyZWRpZW50cyhyeE5vcm1Db2RlIENvZGUpOgogIGZsYXR0ZW4gKAogICAgW01lZGljYXRpb25Lbm93bGVkZ2U6IHJ4Tm9ybUNvZGVdIE0KICAgICAgcmV0dXJuCiAgICAgICAgTS5pbmdyZWRpZW50IEkKICAgICAgICAgIHdoZXJlIEkuY29kZSBpbiAiT3Bpb2lkIEluZ3JlZGllbnRzIiAvLyBUT0RPOiBOZWVkIGEgdmFsdWUgc2V0IG9mIG9waW9pZCBpbmdyZWRpZW50cwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcnhOb3JtQ29kZTogTS5jb2RlLAogICAgICAgICAgICBkb3NlRm9ybUNvZGU6IE0uZG9zZUZvcm0sIC8vIFRPRE86IE1lZGljYXRpb25Lbm93bGVkZ2Ugc3BlY2lmaWVzIFNOT01FRC1DVCBkb3NlIGZvcm1zIGhlcmUsIHdvdWxkIG5lZWQgdG8gcHJvZmlsZSB0byBSWE5vcm0KICAgICAgICAgICAgZG9zZUZvcm1OYW1lOiBNLmRvc2VGb3JtLnRleHQsCiAgICAgICAgICAgIGluZ3JlZGllbnRDb2RlOiBJLml0ZW0gYXMgQ29kZWFibGVDb25jZXB0LCAvLyBUT0RPOiBQcm9maWxlIHRvIGNvZGUgb25seQogICAgICAgICAgICBpbmdyZWRpZW50TmFtZTogKEkuaXRlbSBhcyBDb2RlYWJsZUNvbmNlcHQpLnRleHQsCiAgICAgICAgICAgIHN0cmVuZ3RoOiBFbnN1cmVNaWNyb2dyYW1RdWFudGl0eShJLnN0cmVuZ3RoLmRlbm9taW5hdG9yKSAvLyBUT0RPOiBJcyB0aGlzIGNvcnJlY3Q/CiAgICAgICAgICB9CiAgKSAqLwoKLyoKICBDYWxjdWxhdGVzIGRhaWx5IGRvc2UgZm9yIGEgc3BlY2lmaWMgaW5ncmVkaWVudCBiYXNlZCBvbiB0aGUgaW5ncmVkaWVudCBzdHJlbmd0aCwgZG9zZSBmb3JtLCBkb3NlIHF1YW50aXR5LCBhbmQgZGFpbHkgZnJlcXVlbmN5CiovCmRlZmluZSBmdW5jdGlvbiBHZXREYWlseURvc2UoaW5ncmVkaWVudENvZGUgU3lzdGVtLkNvZGUsIHN0cmVuZ3RoIFN5c3RlbS5RdWFudGl0eSwgZG9zZUZvcm1Db2RlIFN5c3RlbS5Db2RlLCBkb3NlUXVhbnRpdHkgU3lzdGVtLlF1YW50aXR5LCBkb3Nlc1BlckRheSBTeXN0ZW0uRGVjaW1hbCk6CiAgY2FzZQoJICAvKiBpZiBwYXRjaCAtLT4gZGFpbHkgZG9zZSA9IGRvc2UgdmFsdWUgKGUuZywgbnVtYmVyIHBhdGNoZXMgd2l0aCBkb3NlUXVhbnRpdHkgdW5pdCA9ICJwYXRjaCIpICogcGVyLWhvdXIgc3RyZW5ndGggKi8KICAgIHdoZW4gSXNQYXRjaChkb3NlRm9ybUNvZGUpIHRoZW4KICAgICAgLyogYnVwcmVub3JwaGluZSBvciBmZW50YW55bCBwYXRjaCAqLwogICAgICBpZiBUb0ludGVnZXIoaW5ncmVkaWVudENvZGUuY29kZSkgaW4geyAxODE5LCA0MzM3IH0gdGhlbgogICAgICAgIFN5c3RlbS5RdWFudGl0eSB7CiAgICAgICAgICB2YWx1ZTogZG9zZXNQZXJEYXkgKiBkb3NlUXVhbnRpdHkudmFsdWUgKiBzdHJlbmd0aC52YWx1ZSwKICAgICAgICAgIHVuaXQ6IHN0cmVuZ3RoLnVuaXQKICAgICAgICB9CiAgICAgIGVsc2UKICAgICAgICBudWxsCgogICAgLyogaWYgZG9zZSB1bml0IGluIGFjdHVhbCBtYXNzIHVuaXRzIChtZyBvciBtY2cgLS0gd2hlbiBpdCdzIGEgc2luZ2xlIG1lZCkgLS0+IGRhaWx5IGRvc2UgPSBudW1UaW1lc1BlckRheSAqIGRvc2UgKi8KICAgIHdoZW4gZG9zZVF1YW50aXR5LnVuaXQgaW4geyAnbWcnLCAnbWNnJyB9IHRoZW4KICAgICAgU3lzdGVtLlF1YW50aXR5IHsKICAgICAgICB2YWx1ZTogZG9zZXNQZXJEYXkgKiBkb3NlUXVhbnRpdHkudmFsdWUsCiAgICAgICAgdW5pdDogZG9zZVF1YW50aXR5LnVuaXQKICAgICAgfQoKICAgIC8qIGlmIGRvc2VRdWFudGl0eSBpcyBpbiBhY3R1YWwgdm9sdW1lIHVuaXRzIChtTCkgLS0+IGRhaWx5IGRvc2UgPSBudW1UaW1lc1BlckRheSAqIGRvc2UgKiBzdHJlbmd0aCAqLwogICAgd2hlbiBkb3NlUXVhbnRpdHkudW5pdCA9ICdtTCcgYW5kIChQb3NpdGlvbk9mKCcvbUwnLCBzdHJlbmd0aC51bml0KSA9IExlbmd0aChzdHJlbmd0aC51bml0KSAtIDMpIHRoZW4KICAgICAgU3lzdGVtLlF1YW50aXR5IHsKICAgICAgICB2YWx1ZTogZG9zZXNQZXJEYXkgKiBkb3NlUXVhbnRpdHkudmFsdWUgKiBzdHJlbmd0aC52YWx1ZSwKICAgICAgICB1bml0OiBTdWJzdHJpbmcoc3RyZW5ndGgudW5pdCwgMCwgUG9zaXRpb25PZignLycsIHN0cmVuZ3RoLnVuaXQpKQogICAgICB9CgoJCS8qIGlmIGRvc2VRdWFudGl0eSBpcyBub3QgaW4gYWN0dWFsIHVuaXRzIChlLmcuLCAxIHRhYiwgMSBzcHJheSAtLSB3aGVuIGl0J3MgYSBjb21ibyBtZWQgd2l0aCBhIHVuaXQgb2YgdGFibGV0LCBvciBpdCdzIG1nL2FjdHVhdCkgLS0+ICBkYWlseSBkb3NlID0gbnVtVGltZXNQZXJEYXkgKiBkb3NlIHZhbHVlICogc3RyZW5ndGggdmFsdWUgKi8KICAgIGVsc2UKICAgICAgU3lzdGVtLlF1YW50aXR5IHsKICAgICAgICB2YWx1ZTogZG9zZXNQZXJEYXkgKiBkb3NlUXVhbnRpdHkudmFsdWUgKiBzdHJlbmd0aC52YWx1ZSwKICAgICAgICB1bml0OiBTdWJzdHJpbmcoc3RyZW5ndGgudW5pdCwgMCwgUG9zaXRpb25PZignLycsIHN0cmVuZ3RoLnVuaXQpKQogICAgICB9CiAgZW5kCgpkZWZpbmUgZnVuY3Rpb24gR2V0TWVkaWNhdGlvbkNvbmNlcHROYW1lKGNvbmNlcHQgQ29uY2VwdCk6CiAgaWYgY29uY2VwdC5kaXNwbGF5IGlzIG51bGwgdGhlbgogICAgRmlyc3QoCiAgICAgIChjb25jZXB0LmNvZGVzKSBDCiAgICAgICAgd2hlcmUgQy5zeXN0ZW0gPSAnaHR0cDovL3d3dy5ubG0ubmloLmdvdi9yZXNlYXJjaC91bWxzL3J4bm9ybScKICAgICAgICByZXR1cm4gR2V0TWVkaWNhdGlvbk5hbWUoQykKICAgICkKICBlbHNlCiAgICBjb25jZXB0LmRpc3BsYXkKICAgICAgCmRlZmluZSBmdW5jdGlvbiBHZXRNZWRpY2F0aW9uTmFtZShyeE5vcm1Db2RlIFN5c3RlbS5Db2RlKToKICBpZiByeE5vcm1Db2RlLmRpc3BsYXkgaXMgbnVsbCB0aGVuCiAgICBTaW5nbGV0b25Gcm9tKAogICAgICBPTVRLRGF0YS5EcnVnSW5ncmVkaWVudHMgREkKICAgICAgICB3aGVyZSBESS5kcnVnQ29kZSA9IFRvSW50ZWdlcihyeE5vcm1Db2RlLmNvZGUpCiAgICAgICAgcmV0dXJuIERJLmRydWdOYW1lCiAgICApCiAgICBlbHNlIHJ4Tm9ybUNvZGUuZGlzcGxheQoKLyoKICBCdWlsZHMgYSBkZXNjcmlwdGlvbiBmb3IgdGhlIGRhaWx5IGRvc2UgZm9yIGFuIGluZ3JlZGllbnQKKi8KZGVmaW5lIGZ1bmN0aW9uIEdldERhaWx5RG9zZURlc2NyaXB0aW9uKGluZ3JlZGllbnRDb2RlIFN5c3RlbS5Db2RlLCBpbmdyZWRpZW50TmFtZSBTeXN0ZW0uU3RyaW5nLCBzdHJlbmd0aCBTeXN0ZW0uUXVhbnRpdHksIGRvc2VGb3JtQ29kZSBTeXN0ZW0uQ29kZSwgZG9zZUZvcm1OYW1lIFN5c3RlbS5TdHJpbmcsIGRvc2VRdWFudGl0eSBTeXN0ZW0uUXVhbnRpdHksIGRvc2VzUGVyRGF5IFN5c3RlbS5EZWNpbWFsLCBkYWlseURvc2UgU3lzdGVtLlF1YW50aXR5KToKICBjYXNlCiAgICAvKiBpZiBwYXRjaCAqLwogICAgd2hlbiBJc1BhdGNoKGRvc2VGb3JtQ29kZSkgdGhlbgogICAgICAvKiBidXByZW5vcnBoaW5lIG9yIGZlbnRhbnlsIHBhdGNoICovCiAgICAgIGlmIFRvSW50ZWdlcihpbmdyZWRpZW50Q29kZS5jb2RlKSBpbiB7IDE4MTksIDQzMzcgfSB0aGVuCiAgICAgICAgaW5ncmVkaWVudE5hbWUgKyAnIHBhdGNoOiAnICsgVG9TdHJpbmcoZG9zZVF1YW50aXR5LnZhbHVlKSArICcgKiAnICsgVG9TdHJpbmcoc3RyZW5ndGgudmFsdWUpICsgJyA9ICcgKyBUb1N0cmluZyhkYWlseURvc2UudmFsdWUpCiAgICAgIGVsc2UKICAgICAgICBudWxsCgogICAgLyogaWYgZG9zZSB1bml0IGluIGFjdHVhbCBtYXNzIHVuaXRzIChtZyBvciBtY2cgLS0gd2hlbiBpdCdzIGEgc2luZ2xlIG1lZCkgKi8KICAgIHdoZW4gZG9zZVF1YW50aXR5LnVuaXQgaW4geyAnbWcnLCAnbWNnJyB9IHRoZW4KICAgICAgaW5ncmVkaWVudE5hbWUgKyAnICcgKyBkb3NlRm9ybU5hbWUgKyAnOiAnICsgVG9TdHJpbmcoZG9zZXNQZXJEYXkpICsgJy9kICogJyArIFRvU3RyaW5nKGRvc2VRdWFudGl0eS52YWx1ZSkgKyAnID0gJyArIFRvU3RyaW5nKGRhaWx5RG9zZS52YWx1ZSkKCiAgICAvKiBpZiBkb3NlUXVhbnRpdHkgaW4gYWN0dWFsIHZvbHVtZSB1bml0cyAobUwpIG9yIG5vdCBpbiBhY3R1YWwgdW5pdHMgKGUuZy4gMSB0YWIsIDEgc3ByYXkpICovCiAgICBlbHNlCiAgICAgIGluZ3JlZGllbnROYW1lICsgJyAnICsgZG9zZUZvcm1OYW1lICsgJzogJyArIFRvU3RyaW5nKGRvc2VzUGVyRGF5KSArICcvZCAqICcgKyBUb1N0cmluZyhkb3NlUXVhbnRpdHkudmFsdWUpICsgJyAqICcgKyBUb1N0cmluZyhzdHJlbmd0aC52YWx1ZSkgKyAnID0gJyArIFRvU3RyaW5nKGRhaWx5RG9zZS52YWx1ZSkKICBlbmQKCi8qCiAgQ2FsY3VsYXRlcyBNTUVzIGZvciB0aGUgZ2l2ZW4gaW5wdXQgcHJlc2NyaXB0aW9uIGluZm9ybWF0aW9uIGFuZCByZXR1cm5zIGl0CiAgYXMgYSBsaXN0IG9mIHR1cGxlczoKCiAgTGlzdDxUdXBsZSB7CiAgICByeE5vcm1Db2RlIENvZGUsCiAgICBkb3NlRm9ybUNvZGUgQ29kZSwKICAgIGRvc2VRdWFudGl0eSBRdWFudGl0eSwKICAgIGRvc2VzUGVyRGF5IERlY2ltYWwsCiAgICBpbmdyZWRpZW50Q29kZSBDb2RlLAogICAgaW5ncmVkaWVudE5hbWUgU3RyaW5nLAogICAgc3RyZW5ndGggUXVhbnRpdHksCiAgICBkYWlseURvc2UgUXVhbnRpdHksCiAgICBkYWlseURvc2VEZXNjcmlwdGlvbiBTdHJpbmcsCiAgICBjb252ZXJzaW9uRmFjdG9yIERlY2ltYWwsCiAgICBtbWUgUXVhbnRpdHkKICB9PgoqLwpkZWZpbmUgZnVuY3Rpb24gQ2FsY3VsYXRlTU1FcyhtZWRpY2F0aW9ucyBMaXN0PFR1cGxlIHsgcnhOb3JtQ29kZSBTeXN0ZW0uQ29kZSwgZG9zZVF1YW50aXR5IFN5c3RlbS5RdWFudGl0eSwgZG9zZXNQZXJEYXkgU3lzdGVtLkRlY2ltYWwgfT4pOgogIEZsYXR0ZW4oCiAgICBtZWRpY2F0aW9ucyBNCiAgICAgIGxldCBJbmdyZWRpZW50czogR2V0SW5ncmVkaWVudHMoTS5yeE5vcm1Db2RlKQogICAgICByZXR1cm4KICAgICAgICBJbmdyZWRpZW50cyBJCiAgICAgICAgICBsZXQKICAgICAgICAgICAgYWRqdXN0ZWREb3NlUXVhbnRpdHk6IEVuc3VyZU1pY3JvZ3JhbVF1YW50aXR5KE0uZG9zZVF1YW50aXR5KSwKICAgICAgICAgICAgZGFpbHlEb3NlOiBHZXREYWlseURvc2UoSS5pbmdyZWRpZW50Q29kZSwgSS5zdHJlbmd0aCwgSS5kb3NlRm9ybUNvZGUsIGFkanVzdGVkRG9zZVF1YW50aXR5LCBNLmRvc2VzUGVyRGF5KSwKICAgICAgICAgICAgZmFjdG9yOiBHZXRDb252ZXJzaW9uRmFjdG9yKEkuaW5ncmVkaWVudENvZGUsIGRhaWx5RG9zZSwgSS5kb3NlRm9ybUNvZGUpCiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICByeE5vcm1Db2RlOiBNLnJ4Tm9ybUNvZGUsCiAgICAgICAgICAgIGRvc2VGb3JtQ29kZTogSS5kb3NlRm9ybUNvZGUsCiAgICAgICAgICAgIGRvc2VRdWFudGl0eTogYWRqdXN0ZWREb3NlUXVhbnRpdHksCiAgICAgICAgICAgIGRvc2VzUGVyRGF5OiBNLmRvc2VzUGVyRGF5LAogICAgICAgICAgICBpbmdyZWRpZW50Q29kZTogSS5pbmdyZWRpZW50Q29kZSwKICAgICAgICAgICAgaW5ncmVkaWVudE5hbWU6IEkuaW5ncmVkaWVudE5hbWUsCiAgICAgICAgICAgIHN0cmVuZ3RoOiBJLnN0cmVuZ3RoLAogICAgICAgICAgICBkYWlseURvc2U6IGRhaWx5RG9zZSwKICAgICAgICAgICAgZGFpbHlEb3NlRGVzY3JpcHRpb246IEdldERhaWx5RG9zZURlc2NyaXB0aW9uKEkuaW5ncmVkaWVudENvZGUsIEkuaW5ncmVkaWVudE5hbWUsIEkuc3RyZW5ndGgsIEkuZG9zZUZvcm1Db2RlLCBJLmRvc2VGb3JtTmFtZSwgYWRqdXN0ZWREb3NlUXVhbnRpdHksIE0uZG9zZXNQZXJEYXksIGRhaWx5RG9zZSksCiAgICAgICAgICAgIGNvbnZlcnNpb25GYWN0b3I6IGZhY3RvciwKICAgICAgICAgICAgbW1lOiBTeXN0ZW0uUXVhbnRpdHkgewogICAgICAgICAgICAgIHZhbHVlOiBkYWlseURvc2UudmFsdWUgKiBmYWN0b3IsCiAgICAgICAgICAgICAgdW5pdDogZGFpbHlEb3NlLnVuaXQgKyAnL2QnCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICApCgovKiBkZWZpbmUgVGVzdENhbGN1bGF0ZU1NRXM6CiAgQ2FsY3VsYXRlTU1Fcyh7IHsgcnhOb3JtQ29kZTogQ29kZSAnMzg4NTA4JyBmcm9tIFJ4Tm9ybSwgZG9zZVF1YW50aXR5OiBRdWFudGl0eSB7IHZhbHVlOiAxLCB1bml0OiAncGF0Y2gnIH0sIGRvc2VzUGVyRGF5OiAwLjMzIH0gfSkgKi8K"
  } ]
}